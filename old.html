
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Simple Block Editor</title>
  <meta name="description" content="A simple block diagram editor that includes context menus for changing shapes and colors." />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Copyright 1998-2020 by Northwoods Software Corporation. -->

  <script src="https://unpkg.com/gojs/release/go-debug.js"></script>
  <!-- custom text editors -->
  <script src="https://unpkg.com/gojs/extensions/TextEditorSelectBox.js"></script>
  <script src="https://unpkg.com/gojs/extensions/DrawCommandHandler.js"></script>
  <script src="https://unpkg.com/gojs/extensions/TextEditorRadioButtons.js"></script>  
  <script src="https://unpkg.com/gojs/extensions/Figures.js"></script>
  <script src="https://unpkg.com/gojs/extensions/DrawCommandHandler.js"></script>

  <script id="code">
    function init() {
      if (window.goSamples) goSamples();  // init for these samples -- you don't need to call this
      var $ = go.GraphObject.make;

      myDiagram =
        $(go.Diagram, "myDiagramDiv",
          {
            padding: 20,  // extra space when scrolled all the way
            grid: $(go.Panel, "Grid",  // a simple 10x10 grid
              $(go.Shape, "LineH", { stroke: "lightgray", strokeWidth: 0.5 }),
              $(go.Shape, "LineV", { stroke: "lightgray", strokeWidth: 0.5 })
            ),
            "draggingTool.isGridSnapEnabled": true,
            handlesDragDropForTopLevelParts: true,
            mouseDrop: function(e) {
              // when the selection is dropped in the diagram's background,
              // make sure the selected Parts no longer belong to any Group
              var ok = e.diagram.commandHandler.addTopLevelParts(e.diagram.selection, true);
              if (!ok) e.diagram.currentTool.doCancel();
            },
            commandHandler: $(DrawCommandHandler),  // support offset copy-and-paste
            "clickCreatingTool.archetypeNodeData": { text: "NEW NODE" },  // create a new node by double-clicking in background
            "PartCreated": function(e) {
              var node = e.subject;  // the newly inserted Node -- now need to snap its location to the grid
              node.location = node.location.copy().snapToGridPoint(e.diagram.grid.gridOrigin, e.diagram.grid.gridCellSize);
              setTimeout(function() {  // and have the user start editing its text
                e.diagram.commandHandler.editTextBlock();
              }, 20);
            },
            "commandHandler.archetypeGroupData": { isGroup: true, text: "NEW GROUP" },
            "SelectionGrouped": function(e) {
              var group = e.subject;
              setTimeout(function() {  // and have the user start editing its text
                e.diagram.commandHandler.editTextBlock();
              })
            },
            "LinkRelinked": function(e) {
              // re-spread the connections of other links connected with both old and new nodes
              var oldnode = e.parameter.part;
              oldnode.invalidateConnectedLinks();
              var link = e.subject;
              if (e.diagram.toolManager.linkingTool.isForwards) {
                link.toNode.invalidateConnectedLinks();
              } else {
                link.fromNode.invalidateConnectedLinks();
              }
            },
            "undoManager.isEnabled": true
          });


       //###############################NODE TEMPLATE###########################################

      myDiagram.nodeTemplate =
        $(go.Node, 
        'Spot',
          {
            locationSpot: go.Spot.Center, locationObjectName: "SHAPE",
            
            resizable: false
          },
          // these Bindings are TwoWay because the DraggingTool and ResizingTool modify the target properties
          new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
          new go.Binding("desiredSize", "size", go.Size.parse).makeTwoWay(go.Size.stringify),

          $(go.TextBlock,
            { margin: 1, textAlign: "center", portId: "", fromSpot: go.Spot.AllSides, toSpot: go.Spot.AllSides, editable: true, font: "bold 30pt serif" },
            // this Binding is TwoWay due to the user editing the text with the TextEditingTool
            new go.Binding("text").makeTwoWay(),
            new go.Binding("stroke", "color"))
        );

      // Node selection adornment
      // Include four large triangular buttons so that the user can easily make a copy
      // of the node, move it to be in that direction relative to the original node,
      // and add a link to the new node.

      function makeArrowButton(spot, fig) {
        var maker = function(e, shape) {
            e.handled = true;
            e.diagram.model.commit(function(m) {
              var selnode = shape.part.adornedPart;
              // create a new node in the direction of the spot
              var p = new go.Point().setRectSpot(selnode.actualBounds, spot);
              
              //var name = window.prompt(p);
              
              p.subtract(selnode.location);
              p.scale(2, 2);
              p.x += Math.sign(p.x) * 60;
              p.y += Math.sign(p.y) * 60;
              p.add(selnode.location);
              p.snapToGridPoint(e.diagram.grid.gridOrigin, e.diagram.grid.gridCellSize);
              // make the new node a copy of the selected node
              var nodedata = m.copyNodeData(selnode.data);
              // add to same group as selected node
              m.setGroupKeyForNodeData(nodedata, m.getGroupKeyForNodeData(selnode.data));
              m.addNodeData(nodedata);  // add to model
              // create a link from the selected node to the new node
              var linkdata = { from: selnode.key, to: m.getKeyForNodeData(nodedata) };
              m.addLinkData(linkdata);  // add to model
              // move the new node to the computed location, select it, and start to edit it
              var newnode = e.diagram.findNodeForData(nodedata);
              newnode.location = p;
              e.diagram.select(newnode);
              setTimeout(function() {
                e.diagram.commandHandler.editTextBlock();
              }, 20);
            });
          };
        return $(go.Shape,
          {
            figure: fig,
            alignment: spot, alignmentFocus: spot.opposite(),
            width: (spot.equals(go.Spot.Top) || spot.equals(go.Spot.Bottom)) ? 36 : 18,
            height: (spot.equals(go.Spot.Top) || spot.equals(go.Spot.Bottom)) ? 18 : 36,
            fill: "orange", strokeWidth: 0,
            isActionable: true,  // needed because it's in an Adornment
            click: maker, contextClick: maker
          });
      }

      // create a button that brings up the context menu
      myDiagram.nodeTemplate.selectionAdornmentTemplate =
        $(go.Adornment, "Spot",
          $(go.Placeholder, { padding: 10 }),
          makeArrowButton(go.Spot.Top, "TriangleUp"),
          makeArrowButton(go.Spot.Left, "TriangleLeft"),
          makeArrowButton(go.Spot.Right, "TriangleRight"),
          makeArrowButton(go.Spot.Bottom, "TriangleDown"),
          //CMButton({ alignment: new go.Spot(0.75, 0) })
        );



      //###############################LINK TEMPLATE###########################################

      myDiagram.linkTemplate =
        $(go.Link,
          {
            relinkableFrom: true, relinkableTo: true,
            reshapable: true, resegmentable: true
          },
          
          $(go.Shape)
 
        );
      load();
    }

    // save a model to and load a model from JSON-formatted text, displayed below the Diagram
    function save() {
      var str = myDiagram.model.toJson();
      document.getElementById("mySavedModel").value = str;
    }
    function load() {
      var str = document.getElementById("mySavedModel").value;
      myDiagram.model = go.Model.fromJson(str);
    }
  </script>
</head>
<body onload="init()">
<div id="sample">
  <div id="myDiagramDiv" style="border: solid 1px black; width:100%; height:600px"></div>
  <div id="buttons">
    <button id="loadModel" onclick="load()">Load</button>
    <button id="saveModel" onclick="save()">Save</button>
  </div>
  <textarea id="mySavedModel" style="width:100%;height:300px">
{ "class": "GraphLinksModel",
  "nodeDataArray": [ 
{"key":1, "loc":"0 0", "text":"C"},
{"key":2, "loc":"100 0", "text":"H"},
{"key":-3, "loc":"-90 0", "text":"C"},
{"key":-4, "loc":"-90 -110", "text":"H"},
{"key":-5, "loc":"0 -110", "text":"H"},
{"key":-6, "loc":"0 110", "text":"H"},
{"key":-7, "loc":"-90 110", "text":"H"},
{"key":-8, "loc":"-180 0", "text":"C"},
{"key":-9, "loc":"-180 -110", "text":"H"},
{"key":-10, "loc":"-180 110", "text":"H"},
{"key":-11, "loc":"-270 0", "text":"H"}
 ],
  "linkDataArray": [ 
{"from":1, "to":2},
{"from":1, "to":-3},
{"from":-3, "to":-4},
{"from":1, "to":-5},
{"from":1, "to":-6},
{"from":-3, "to":-7},
{"from":-3, "to":-8},
{"from":-8, "to":-9},
{"from":-8, "to":-10},
{"from":-8, "to":-11}
 ]}
  </textarea>
</div>
</body>
</html>